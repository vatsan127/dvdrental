FROM maven:3.9-eclipse-temurin-17 AS builder
WORKDIR /app

COPY pom.xml /app/

COPY src/ /app/src/
RUN mvn clean package -DskipTests

FROM eclipse-temurin:17-jre
ENV USER_ID=1001
ENV GROUP_ID=1001
ENV USER=srivatsan
ENV EVENT_HOME=/opt/EVENT
ENV APP_NAME=dvd-rental

# Create environment home
RUN mkdir -p "$EVENT_HOME"

# Add non-root user
RUN addgroup --gid ${GROUP_ID} ${USER}
RUN adduser --uid ${USER_ID} --gid ${GROUP_ID} --gecos "" --home /home/${USER} --disabled-password --shell /bin/bash ${USER}

# Change ownership
RUN chown -R ${USER}:${GROUP_ID} ${EVENT_HOME}

# Copy the built JAR from the builder stage
COPY --from=builder /app/target/${APP_NAME}*.jar ${EVENT_HOME}/${APP_NAME}.jar

# Set proper permissions
RUN chown -R ${USER}:${GROUP_ID} ${EVENT_HOME}/${APP_NAME}.jar

# Switch to the non-root user
USER ${USER}

# Set the working directory
WORKDIR ${EVENT_HOME}

# Expose ports
EXPOSE 8080
EXPOSE 9091

CMD ["java", "-jar", "dvd-rental.jar"]